import streamlit as st
import pandas as pd
import plotly.express as px
from sklearn.linear_model import LinearRegression

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì „ê¸°ì°¨ì™€ ì¶©ì „ê¸° ë¶„ì„", layout="wide")

# ì œëª©
st.title("ğŸ”Œ ì „ê¸°ì°¨ ë³´ê¸‰ë¥ ê³¼ ì¶©ì „ê¸° ìˆ˜ì˜ ê´€ê³„ ë¶„ì„")

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
@st.cache_data
def load_data():
    df = pd.read_csv("merged_ev_charger.csv", encoding='cp949')
    df["ì¶©ì „ê¸°ìˆ˜"] = df["ì™„ì† ì¶©ì „ê¸°ìˆ˜"] + df["ê¸‰ì† ì¶©ì „ê¸°ìˆ˜"]  # ì—´ ìƒì„±
    df["ë…„ì›”"] = pd.to_datetime(df["ë…„ì›”"], format="%b-%y")     # ì›”-ì—°ë„ ë¬¸ìì—´ â†’ datetime
    return df

df = load_data()

# ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
st.subheader("ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(df)

# ì‚°ì ë„ + íšŒê·€ì„  ì‹œê°í™”
st.subheader("ğŸ“ˆ íšŒê·€ ê¸°ë°˜ ì‚°ì ë„ ì‹œê°í™”")
fig = px.scatter(
    df,
    x="ì¶©ì „ê¸°ìˆ˜",
    y="ì „ê¸°ì°¨ë“±ë¡ëŒ€ìˆ˜",
    title="ì¶©ì „ê¸° ìˆ˜ vs ì „ê¸°ì°¨ ë“±ë¡ëŒ€ìˆ˜",
    labels={"ì¶©ì „ê¸°ìˆ˜": "ì¶©ì „ê¸° ìˆ˜", "ì „ê¸°ì°¨ë“±ë¡ëŒ€ìˆ˜": "ì „ê¸°ì°¨ ë“±ë¡ëŒ€ìˆ˜"},
    trendline="ols",
    template="plotly_white"
)
st.plotly_chart(fig)

# ì„ í˜• íšŒê·€ ë¶„ì„
X = df[['ì¶©ì „ê¸°ìˆ˜']]
y = df['ì „ê¸°ì°¨ë“±ë¡ëŒ€ìˆ˜']
model = LinearRegression().fit(X, y)
r_squared = model.score(X, y)

# ë¶„ì„ ìš”ì•½ ì¶œë ¥
st.markdown("### ğŸ“Œ ë¶„ì„ ìš”ì•½")
st.write(f"**íšŒê·€ê³„ìˆ˜ (ê¸°ìš¸ê¸°)**: {model.coef_[0]:,.2f}")
st.write(f"**ì ˆí¸**: {model.intercept_:,.2f}")
st.write(f"**RÂ² (ì„¤ëª…ë ¥)**: {r_squared:.3f}")
corr = df['ì¶©ì „ê¸°ìˆ˜'].corr(df['ì „ê¸°ì°¨ë“±ë¡ëŒ€ìˆ˜'])
st.write(f"**í”¼ì–´ìŠ¨ ìƒê´€ê³„ìˆ˜**: {corr:.3f}")

st.markdown("""
#### ğŸ” í•´ì„ ê¸°ì¤€
- **ìƒê´€ê³„ìˆ˜ê°€ ë†’ë‹¤ (r â‰¥ 0.7)** â†’ ê°•í•œ ì„ í˜• ê´€ê³„
- **ê¸°ìš¸ê¸° ì–‘ìˆ˜** â†’ ì¶©ì „ê¸° ìˆ˜ ì¦ê°€ ì‹œ ì „ê¸°ì°¨ ë“±ë¡ë„ ì¦ê°€
- **RÂ² ë†’ìŒ** â†’ ì¶©ì „ê¸° ìˆ˜ë§Œìœ¼ë¡œ ì „ê¸°ì°¨ ë“±ë¡ìˆ˜ ìƒë‹¹íˆ ì„¤ëª… ê°€ëŠ¥

#### ğŸ“Š ì‹œê³„ì—´ ê¸°ë°˜ ì¸ê³¼ê´€ê³„ í•´ì„
- ì‹œê³„ì—´ ê·¸ë˜í”„ì—ì„œ ì¶©ì „ê¸° ìˆ˜ ì¦ê°€ê°€ ì „ê¸°ì°¨ ë“±ë¡ ì¦ê°€ë³´ë‹¤ **ì„ í–‰ë˜ëŠ” ê²½í–¥**ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
- ì´ëŠ” ì¶©ì „ ì¸í”„ë¼ í™•ì¶©ì´ ì „ê¸°ì°¨ ë³´ê¸‰ì„ **ìœ ë„í–ˆì„ ê°€ëŠ¥ì„±**ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.
- ì •ë°€í•œ ì¸ê³¼ ë¶„ì„ì—ëŠ” ì¶”ê°€ í†µê³„ ê²€ì •ì´ í•„ìš”í•˜ì§€ë§Œ, **ì‹œê³„ì—´ ì¶”ì„¸ë§Œìœ¼ë¡œë„ ìœ ì˜ë¯¸í•œ ê´€ê³„**ê°€ ë³´ì…ë‹ˆë‹¤.
""")

# ì‹œê³„ì—´ ì‹œê°í™”
st.subheader("ğŸ“Š ì‹œê³„ì—´ ì¶”ì„¸ ë¹„êµ")
fig_time = px.line(
    df.sort_values("ë…„ì›”"),
    x="ë…„ì›”",
    y=["ì™„ì† ì¶©ì „ê¸°ìˆ˜", "ê¸‰ì† ì¶©ì „ê¸°ìˆ˜", "ì „ê¸°ì°¨ë“±ë¡ëŒ€ìˆ˜"],
    title="ì‹œê³„ì—´: ì™„ì†/ê¸‰ì† ì¶©ì „ê¸° ìˆ˜ ë° ì „ê¸°ì°¨ ë“±ë¡ëŒ€ìˆ˜ ì¶”ì„¸",
    labels={"value": "ìˆ˜ëŸ‰", "variable": "í•­ëª©"},
    markers=True,
    template="plotly_white"
)
st.plotly_chart(fig_time)

st.caption("â€» ë°ì´í„°ëŠ” ì „êµ­ ê¸°ì¤€ ëˆ„ì  ìˆ˜ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.")
